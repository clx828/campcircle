# 评论发布功能修复说明

## 问题描述

postDetail.vue 中的评论发布功能有问题，需要参考 CommentPopup 组件中的实现进行修复。

## 🔍 问题分析

### 1. 参数类型不匹配

#### CommentInput 组件发送的数据格式
```typescript
// CommentInput.vue 中的 handleSubmit 函数
emit('submit', {
    content: commentText.value,
    isAnonymous: isAnonymous.value
})
```

#### postDetail.vue 原来的接收格式
```typescript
// 错误的参数类型
const handleCommentSubmit = async (content: string) => {
    // 只接收字符串，无法处理匿名标识
}
```

### 2. CommentPopup 中的正确实现
```typescript
// CommentPopup.vue 中的正确实现
async function handleSubmit(data: { content: string; isAnonymous: boolean }) {
    if (!props.postInfo?.id) return
    
    try {
        uni.showLoading({ title: '发布中...', mask: true })
        
        const params = {
            postId: props.postInfo.id,
            content: data.content.trim(),
            parentId: replyInfo.value.parentId || undefined,
            replyUserId: replyInfo.value.replyUserId || undefined
        }
        
        const response = await postCommentApi.addComment(params)
        // ... 处理响应
    } catch (error) {
        // ... 错误处理
    }
}
```

## ✅ 修复方案

### 1. 修正参数类型

```typescript
// 修复后的 handleCommentSubmit 函数
const handleCommentSubmit = async (data: { content: string; isAnonymous: boolean }) => {
    if (!postId.value) return
    
    try {
        uni.showLoading({ title: '发布中...', mask: true })

        const params = {
            postId: postId.value,
            content: data.content.trim(),
            // 如果是回复评论，使用 parentId
            parentId: replyInfo.value.parentId || undefined,
            // 如果是回复评论，使用被回复用户的 ID
            replyUserId: replyInfo.value.replyId || undefined
        }

        const response = await postCommentApi.addComment(params)

        if (response.code === 0) {
            uni.hideLoading()
            uni.showToast({
                title: '发布成功',
                icon: 'success'
            })

            hideCommentInput()
            // 刷新评论列表
            await loadComments()
        }
    } catch (error) {
        console.error('发布评论失败:', error)
        uni.hideLoading()
        uni.showToast({
            title: '发布失败',
            icon: 'none'
        })
    }
}
```

### 2. 数据流程图

```
CommentInput 组件
    ↓ @click="handleSubmit"
发送按钮点击
    ↓ emit('submit', { content, isAnonymous })
发送数据到父组件
    ↓ @submit="handleCommentSubmit"
postDetail.vue 接收
    ↓ handleCommentSubmit(data)
处理评论提交
    ↓ postCommentApi.addComment(params)
调用 API 发布评论
    ↓ loadComments()
刷新评论列表
```

## 🎯 关键改进

### 1. 参数类型匹配
- **修复前**: 只接收 `content: string`
- **修复后**: 接收 `{ content: string; isAnonymous: boolean }`

### 2. 数据验证
- 添加了 `postId.value` 的验证
- 确保内容不为空再提交

### 3. 回复逻辑
- 正确处理 `parentId`（父评论 ID）
- 正确处理 `replyUserId`（被回复用户 ID）

### 4. 错误处理
- 统一的加载状态管理
- 完善的错误提示

## 📱 使用流程

### 1. 普通评论
1. 用户点击"写评论"按钮
2. CommentInput 弹出，用户输入内容
3. 点击发送按钮
4. 调用 `handleCommentSubmit({ content: "评论内容", isAnonymous: false })`
5. API 调用成功后刷新评论列表

### 2. 回复评论
1. 用户点击某条评论的回复按钮
2. 设置 `replyInfo` 信息
3. CommentInput 弹出，显示回复目标
4. 用户输入回复内容
5. 点击发送按钮
6. 调用 `handleCommentSubmit` 时会包含 `parentId` 和 `replyUserId`

## 🔧 技术细节

### 1. API 参数结构
```typescript
interface AddCommentParams {
    postId: string;           // 帖子 ID
    content: string;          // 评论内容
    parentId?: string;        // 父评论 ID（回复时使用）
    replyUserId?: string;     // 被回复用户 ID（回复时使用）
}
```

### 2. 回复信息结构
```typescript
interface ReplyInfo {
    isReply: boolean;         // 是否是回复
    parentId: string;         // 父评论 ID
    replyId: string;          // 被回复用户 ID
    targetUser: string;       // 被回复用户名
}
```

### 3. 组件事件
```typescript
// CommentInput 组件发送的事件
interface SubmitEvent {
    content: string;          // 评论内容
    isAnonymous: boolean;     // 是否匿名
}
```

## 🚀 测试验证

### 1. 功能测试
- ✅ 发布普通评论
- ✅ 回复评论
- ✅ 匿名评论功能
- ✅ 评论列表刷新

### 2. 错误处理测试
- ✅ 网络错误提示
- ✅ 空内容验证
- ✅ 加载状态显示

### 3. 用户体验测试
- ✅ 发布成功提示
- ✅ 自动关闭输入框
- ✅ 评论列表实时更新

## 📊 修复效果

### 修复前
- 参数类型不匹配导致发布失败
- 无法处理匿名评论功能
- 回复逻辑可能有问题

### 修复后
- 参数类型完全匹配
- 支持匿名评论功能
- 回复逻辑正确处理
- 与 CommentPopup 保持一致

现在 postDetail.vue 中的评论发布功能已经修复，与 CommentPopup 中的实现保持一致！
