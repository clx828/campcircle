# 系统消息功能说明

## 功能概述

系统消息功能为CampCircle应用提供了完整的消息通知系统，支持管理员发送系统通知以及用户行为触发的自动通知。

## 主要功能

### 1. 管理员发送通知接口
- **接口路径**: `POST /system-message/add`
- **权限要求**: 管理员权限
- **功能**: 管理员可以发送系统通知给指定用户或全体用户
- **参数**:
  - `title`: 消息标题
  - `content`: 消息内容
  - `toUserId`: 接收用户ID（可选，为空时发送给所有用户）
  - `type`: 消息类型（0-系统通知）
  - `isGlobal`: 是否为全局消息

### 2. 查询消息接口
- **接口路径**: `POST /system-message/list/page/vo` 或 `POST /system-message/my/list/page/vo`
- **功能**: 分页查询系统消息，按时间最近的顺序排列
- **特性**:
  - 支持多种查询条件筛选
  - **支持类型列表查询**: 可以通过 `types` 参数传递类型列表，查询多个类型的消息
  - 支持单个类型查询: 可以通过 `type` 参数查询单个类型的消息
  - 自动按创建时间倒序排列
  - 普通用户只能查看自己的消息
  - 管理员可以查看所有消息

### 3. 自动消息生产
当用户进行以下操作时，系统会自动生产相应的消息通知：

#### 点赞通知
- **触发条件**: 用户点赞帖子时（仅新增点赞，取消点赞不通知）
- **通知对象**: 帖子作者
- **消息类型**: 1-点赞通知
- **集成位置**: `PostThumbServiceImpl.doPostThumbInner()`
- **逻辑说明**: 只在未点赞状态下点赞时发送通知，已点赞状态下取消点赞不发送通知

#### 收藏通知
- **触发条件**: 用户收藏帖子时（仅新增收藏，取消收藏不通知）
- **通知对象**: 帖子作者
- **消息类型**: 2-收藏通知
- **集成位置**: `PostFavourServiceImpl.doPostFavourInner()`
- **逻辑说明**: 只在未收藏状态下收藏时发送通知，已收藏状态下取消收藏不发送通知

#### 评论通知
- **触发条件**: 用户评论帖子时（仅新增评论，删除评论不通知）
- **通知对象**: 帖子作者或被回复的用户
- **消息类型**: 3-评论通知
- **集成位置**: `PostCommentServiceImpl.addComment()`
- **逻辑说明**: 只在添加评论时发送通知，删除评论时不发送通知

#### 关注通知
- **触发条件**: 用户关注其他用户时（仅新增关注，取消关注不通知）
- **通知对象**: 被关注的用户
- **消息类型**: 4-关注通知
- **集成位置**: `FollowServiceImpl.doFollowInner()`
- **逻辑说明**: 只在未关注状态下关注时发送通知，已关注状态下取消关注不发送通知

## 数据库设计

### system_message表结构
```sql
CREATE TABLE IF NOT EXISTS system_message (
    id          BIGINT AUTO_INCREMENT COMMENT 'id' PRIMARY KEY,
    fromUserId  BIGINT       DEFAULT 0                 NOT NULL COMMENT '发送用户 id（系统消息时为0）',
    toUserId    BIGINT                                 NULL COMMENT '接收用户 id（全局消息时为空）',
    title       VARCHAR(80)                            NOT NULL COMMENT '消息标题',
    content     TEXT                                   NOT NULL COMMENT '消息内容',
    type        TINYINT                                NOT NULL COMMENT '消息类型：0-系统通知，1-点赞通知，2-收藏通知，3-评论通知，4-关注通知',
    postId      BIGINT                                 NULL COMMENT '关联的帖子ID',
    commentId   BIGINT                                 NULL COMMENT '关联的评论ID',
    status      TINYINT      DEFAULT 1                 NOT NULL COMMENT '状态：1-未读，0-已读',
    isGlobal    TINYINT      DEFAULT 0                 NOT NULL COMMENT '是否为全局消息：0-否，1-是',
    createTime  DATETIME     DEFAULT CURRENT_TIMESTAMP NOT NULL COMMENT '创建时间',
    updateTime  DATETIME     DEFAULT CURRENT_TIMESTAMP NOT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    isDelete    TINYINT      DEFAULT 0                 NOT NULL COMMENT '是否删除'
);
```

## API接口列表

### 管理员接口
1. `POST /system-message/add` - 发送系统通知
2. `POST /system-message/update` - 更新系统消息
3. `POST /system-message/delete` - 删除系统消息
4. `POST /system-message/send-notification` - 快速发送通知

### 用户接口
1. `POST /system-message/my/list/page/vo` - 获取我的消息列表
2. `GET /system-message/get/vo/{id}` - 获取消息详情
3. `POST /system-message/mark-read/{messageId}` - 标记消息为已读
4. `POST /system-message/mark-all-read` - 批量标记消息为已读
5. `GET /system-message/unread-count` - 获取未读消息数量

## 消息类型说明

| 类型值 | 类型名称 | 描述 | 触发条件 |
|--------|----------|------|----------|
| 0 | 系统通知 | 管理员发送的系统公告 | 管理员手动发送 |
| 1 | 点赞通知 | 帖子被点赞的通知 | 用户点赞帖子 |
| 2 | 收藏通知 | 帖子被收藏的通知 | 用户收藏帖子 |
| 3 | 评论通知 | 帖子被评论的通知 | 用户评论帖子 |
| 4 | 关注通知 | 被关注的通知 | 用户关注其他用户 |

## 使用示例

### 1. 管理员发送系统通知
```json
POST /system-message/add
{
    "title": "系统维护通知",
    "content": "系统将于今晚22:00-24:00进行维护，请提前保存数据。",
    "type": 0,
    "isGlobal": 1
}
```

### 2. 查询我的消息
```json
POST /system-message/my/list/page/vo
{
    "current": 1,
    "pageSize": 10,
    "type": 1,
    "status": 0
}
```

### 3. 使用类型列表查询多种类型消息
```json
POST /system-message/my/list/page/vo
{
    "current": 1,
    "pageSize": 10,
    "types": [1, 2],  // 查询点赞和收藏消息
    "status": 1       // 只查未读消息
}
```

### 4. 查询单个类型消息
```json
POST /system-message/my/list/page/vo
{
    "current": 1,
    "pageSize": 10,
    "type": 3,        // 查询评论消息
    "status": 1       // 只查未读消息
}
```

### 5. 查询所有消息
```json
POST /system-message/my/list/page/vo
{
    "current": 1,
    "pageSize": 10,
    "status": 1       // 只查未读消息，不指定type或types则查询所有类型
}
```

### 6. 获取未读消息统计
```json
GET /system-message/unread-count

Response:
{
    "code": 0,
    "data": {
        "total": 8,              // 总未读数
        "system": 2,             // 系统通知未读数
        "likeFavour": 4,         // 点赞和收藏未读数
        "commentFollow": 2       // 评论和关注未读数
    }
}
```

### 7. 批量标记消息为已读

#### 标记系统通知为已读
```json
POST /system-message/mark-system-read

Response:
{
    "code": 0,
    "data": 2,        // 标记成功的数量
    "message": "标记成功"
}
```

#### 标记点赞和收藏消息为已读
```json
POST /system-message/mark-like-favour-read

Response:
{
    "code": 0,
    "data": 4,        // 标记成功的数量
    "message": "标记成功"
}
```

#### 标记评论和关注消息为已读
```json
POST /system-message/mark-comment-follow-read

Response:
{
    "code": 0,
    "data": 2,        // 标记成功的数量
    "message": "标记成功"
}
```

#### 批量标记指定类型消息为已读
```json
POST /system-message/mark-types-read
[1, 2]   // 标记点赞和收藏消息为已读

Response:
{
    "code": 0,
    "data": 4,        // 标记成功的数量
    "message": "标记成功"
}
```

## 通知逻辑说明

### 正向操作通知（发送通知）
- ✅ **点赞帖子**: 从未点赞状态变为点赞状态时发送通知
- ✅ **收藏帖子**: 从未收藏状态变为收藏状态时发送通知
- ✅ **评论帖子**: 添加新评论时发送通知
- ✅ **关注用户**: 从未关注状态变为关注状态时发送通知

### 反向操作通知（不发送通知）
- ❌ **取消点赞**: 从点赞状态变为未点赞状态时不发送通知
- ❌ **取消收藏**: 从收藏状态变为未收藏状态时不发送通知
- ❌ **删除评论**: 删除已有评论时不发送通知
- ❌ **取消关注**: 从关注状态变为未关注状态时不发送通知

## 注意事项

1. **权限控制**: 管理员接口需要管理员权限，普通用户只能查看自己的消息
2. **消息去重**: 系统不会给自己发送通知（如自己点赞自己的帖子）
3. **异常处理**: 消息发送失败不会影响主业务流程，只会记录错误日志
4. **性能优化**: 查询接口支持分页和索引优化
5. **数据一致性**: 消息发送采用异步方式，避免影响主业务性能
6. **通知策略**: 只有正向操作（点赞、收藏、评论、关注）才发送通知，反向操作（取消点赞、取消收藏、删除评论、取消关注）不发送通知

## 扩展功能

系统预留了扩展接口，可以方便地添加新的消息类型和通知场景：

1. 实现 `SystemMessageService` 中的相应方法
2. 在业务逻辑中调用消息发送接口
3. 更新消息类型枚举和描述映射

## 测试

运行测试类 `SystemMessageServiceTest` 可以验证系统消息功能的正确性。
